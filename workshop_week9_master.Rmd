## Getting Started

To setup, copy all the text on this screen. Then log in to https://rstudio.middlebury.edu, and in the "File" menu select "New File" then "R Markdown". Paste this file and save it.

Now let's load the packages and the data:

```{r load packages and data}
library(dplyr)
library(ggplot2)
library(RCurl)

workshop9_raw_data <- getURL("https://raw.githubusercontent.com/lawrence-midd/soan245/master/colleges.csv")
colleges <- read.csv(text = workshop9_raw_data)

colleges$name <- as.character(colleges$name)
```


## Descriptive Statistics

We'll start by seeing how the *New York Times* uses Chetty et al's big dataset for their analyses. One thing to note: the *NYT* only used one cohort from Chetty's dataset; we'll use data pooled from the 1980-1982 cohorts. Most of the overall patterns we will see are similar to what the *NYT* reported but a few numbers will be slightly different.

We want to find the proportion of students at every college whose parents are in the top 1% of the income distribution and the proportion of students at every college whose parents are in the bottom 60% of the income distribution.

There is a variable for the proportion of students from the top 1%: `par_top1pc`. Let's find that value for Middlebury College:

```{r}
colleges$par_top1pc[colleges$name=="Middlebury College"]
```

The *NYT* chose to focus on the top 1%. The dataset also includes variables for the proportion of students from the top 5% and the top 10% that follow the same coding syntax as the variable for the proportion from the top 1%. Try to find the proportion of students at Middlebury from the top 5% and the proportion of students from a different institution from the top 10%:

```{r}
colleges$par_top5pc[colleges$name=="Middlebury College"]
colleges$par_top10pc[colleges$name=="University Of Vermont And State Agricultural College"]
```

After the top 10% of the income distribution, students are grouped by income quintile from quintile 1 (the bottom 20%) to quintile 5 (the top 20%). The variable for the proportion of students from the bottom 20% is `par_q1` and the variable for the proportion of students from the top 20% is `par_q5`. How would we use these variables to find the proportion of students from the bottom 60%?

```{r}
colleges$par_bottom60pc <- colleges$par_q1 + colleges$par_q2 + colleges$par_q3
```

What proportion of Middlebury College studentes come from families in the bottom 60% of the income distribution?

```{r}
colleges$par_bottom60pc[colleges$name=="Middlebury College"]
```

Now let's calculate the statistic that the NYT analysis presents as its main finding, the ratio of students from the top 1% to the bottom 60%:

```{r}
colleges$ratio <- colleges$par_top1pc / colleges$par_bottom60pc
```

What is this value for Middlebury? How would you interpret that number?

Let's create a new data frame (called `college_ratios`) that only has the variables needed for this ratio. We'll look at the colleges with the ten highest ratios and create a new variable called `rank` that is each school's rank (with the institution with the highest ratio ranked #1):

```{r}
college_ratios <- colleges %>% 
     arrange(desc(ratio)) %>% 
     mutate(rank = row_number()) %>%
     select(rank, name, ratio, par_top1pc, par_bottom60pc)

college_ratios
```

Find the rank for another college (that is not in the top 10):

```{r}
college_ratios$rank[college_ratios$name=="Stanford University"]
```



## Mobility Measures

Now let's turn to the measures that are the focus on the Chetty paper. The paper uses two variables to try and assess how accessible colleges are to students from the bottom of the income distribution (they call this the `access_rate`) and how successful colleges are at moving students from the bottom of the income distrubtion to the top of the income distribution by age 30 (they call this the `success_rate`). Let's find these two measures for Middlebury:

```{r}
colleges$access_rate[colleges$name=="Middlebury College"]
colleges$success_rate[colleges$name=="Middlebury College"]
```

The product of these is the proportion of all Middlebury students who are from the lowest income quintile and make it to the top income quintile. Chetty et al call this measure the "mobility rate". Let's calculate this measure for all colleges and find it for Middlebury:

```{r}
colleges$mobility_rate <- colleges$access_rate * colleges$success_rate
colleges$mobility_rate[colleges$name=="Middlebury College"]
```

Where does Middlebury's value fall in the overall distribution of mobility rates at four-year colleges?

```{r}
summary(colleges$mobility_rate)
```


## Correlates of Success

Chetty et al use several other college characteristics - gathered from the Common Data Set, the College Scorecard, and other IPEDS databases - to see how they are related to the success, access, and mobility rates. Let's look at cost of attendance first. Would you expect colleges with higher "sticker prices" to have higher or lower success rates on average? 

Let's find the correlation:

```{r}
cor(colleges$sticker_price_2013, colleges$success_rate, use = "complete.obs")
```

The relationship between these two variables might be easier to interpret in a scatterplot with a "line of best fit":

```{r, message = FALSE, warning = FALSE}
plot_instruction <- ggplot(colleges, aes(x = sticker_price_2013, y = success_rate))
plot_instruction + geom_point() + geom_smooth(method = lm)
```


Where is Middlebury's point in this distribution? The trick for identifying a specific observation is to create a new dataframe with only that observation and to layer a scatterplot with only that observation on top of our existing scatterplot. To make things even clearer, we'll change all the other points to a lighter color and give Middlebury a bigger dot in blue:

```{r, error = FALSE, warning = FALSE}
middlebury <- filter(colleges, name == "Middlebury College")

plot_instruction <- ggplot(colleges, aes(x = sticker_price_2013, y = success_rate))
plot_instruction + geom_point()

plot_admit_rate <- ggplot(colleges, aes(x = sticker_price_2013, y = success_rate))
plot_admit_rate + geom_point(color = "light gray") + geom_smooth(method = lm, color = "red") +
     geom_point(data = middlebury, aes(x = sticker_price_2013, y = success_rate), color = "Blue", size = 2) +
     geom_text(data = middlebury, aes(x = sticker_price_2013, y = success_rate + .05, label = "Middlebury"), color = "Blue")
```



`scorecard_netprice_2013`:
`sticker_price_2013`:
`instructional_expenditures_pc_2012`:
`endowment_pc_2000`:
`sat_avg_2013`:
`ipeds_enrollment_2013`:
`average_faculty_salary_2013`:
`admit_rate_2013`:


```{r}
cor(colleges$graduation_rate_2013, colleges$success_rate, use = "complete.obs")
cor(colleges$scorecard_netprice_2013, colleges$success_rate, use = "complete.obs")
cor(colleges$sticker_price_2013, colleges$success_rate, use = "complete.obs")
cor(colleges$instructional_expenditures_pc_2012, colleges$success_rate, use = "complete.obs")
cor(colleges$endowment_pc_2000, colleges$success_rate, use = "complete.obs")
cor(colleges$sat_avg_2013, colleges$success_rate, use = "complete.obs")
cor(colleges$ipeds_enrollment_2013, colleges$success_rate, use = "complete.obs")
cor(colleges$average_faculty_salary_2013, colleges$success_rate, use = "complete.obs")
cor(colleges$admit_rate_2013, colleges$success_rate, use = "complete.obs")
```


colleges$admit_rate_2013[colleges$name=="Middlebury College"]

middlebury <- filter(colleges, name == "Middlebury College")

plot_instruction <- ggplot(colleges, aes(x = log(instructional_expenditures_pc_2012), y = to_top20_if_bottom20))
plot_instruction + geom_point()

plot_admit_rate <- ggplot(colleges, aes(x = admit_rate_2013, y = to_top20_if_bottom20))
plot_admit_rate + geom_point(color = "light gray") + geom_smooth(method = lm, color = "red") +
     geom_point(data = middlebury, aes(x = admit_rate_2013, y = to_top20_if_bottom20), color = "Blue", size = 2) +
     geom_text(data = middlebury, aes(x = admit_rate_2013, y = to_top20_if_bottom20 + .05, label = "Middlebury"), color = "Blue")
